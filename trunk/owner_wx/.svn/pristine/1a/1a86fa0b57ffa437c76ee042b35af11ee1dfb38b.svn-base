import { Component,OnInit } from '@angular/core';
import { RouterModule,ActivatedRoute, Router } from '@angular/router';
import { Http,Jsonp,URLSearchParams,Headers,Response } from '@angular/http';
declare var mui: any;
import { deliverGoodsService } from  './deliverGoods.service';
import { Api } from '../api';
import { Ajax } from '../ajax';
declare var md5:any;
declare var $:any;
@Component({
    selector: 'app-cancelGoods',
    templateUrl: './deliverGoods.component.child.html',
    styleUrls: ['../myGoods/prePaidFreight/prePaidFreight.component.css'
                ,'./deliverGoods.component.child.css'],
    providers:[ deliverGoodsService ]


})

export class PublicGoods {

    public ajax: Ajax;
    // public goodsName = '';
    public info:any;
    constructor(
      private route: ActivatedRoute,
      private router: Router,
      public service : deliverGoodsService,
      public http:Http
    ) {
      this.ajax = new Ajax(this.http);
    }
  //截取金额
  fmoney(s:any, n?:number) {
    n = n > 0 && n <= 20 ? n : 2;
    s = parseFloat((s + "").replace(/[^\d\.-]/g, "")).toFixed(n) + "";
    let l = s.split(".")[0].split("").reverse(), r = s.split(".")[1];
    let t = "";
    for (let i = 0; i < l.length; i++) {
      t += l[i] + ((i + 1) % 3 == 0 && (i + 1) != l.length ? "," : "");
    }
    return t.split("").reverse().join("") + "." + r;
  }
  ngOnInit(): void{
    console.log(this.route.snapshot.params['orderNo']);
    this.service.getOrderInfoByOrderNo(this.route.snapshot.params['orderNo'])
    .then(data=> this.info = data.data);
    //.then(data=>console.log(data)||data)
    //.then(data=>Object.keys(data).forEach(key=>this.info[key] = data[key] ) )
    //.then(()=>console.log(this.info));
    mui('#sheet1').popover('toggle');
    //mui('#sheet1').popover('hide');
    mui.ready(function() {
      console.log(this);
      console.log("ready");
      // 数字索引
      var activeIndex = 0;
      // 密码结果
      var resultValue = "";
      // 所有输入框
      var inputList = mui(".input-item");
      // 所有数字键
      var numberList = mui(".keyboard-number");

        // 数字键盘点击事件
        mui("#keyboard").on("tap", ".keyboard-number", function() {
          console.log("tap");
          if(activeIndex == 6) {
            return;
          }
          var num = this.innerText;
          addNumber(num);
        });

      mui("#keyboard").on("tap", ".keboard-action", function() {
        var value = this.getAttribute("data-action");
        switch(value) {
          case "cancel":
            if(activeIndex == 0) {
              return;
            }
            cancelNumber();
            break;
          case "reset":
            resetInput();
            break;
          default:
            break;
        }
      });
      // 添加数字
      var addNumber = (num) => {
        inputList[activeIndex].innerText = "*";
        resultValue += num;
        activeIndex++;
        // 检测密码长度
        if (activeIndex == 6) {
          // 假定123456是正确密码
          this.publishOrderInfo(this.route.snapshot.params['orderNo'], resultValue).then(data=> {
            if (data.msg!== 'success') {
              mui.toast(data.msg);
              //wrongPassword();
            } else {
              $('.box').css('display', 'none');
              this.router.navigateByUrl("deliverGoods/Success");
              console.log(1111);
            }
          });
        }
      };
      // 撤销数字
      function cancelNumber() {
        activeIndex--;
        inputList[activeIndex].innerText = "";
        resultValue = resultValue.substring(0, resultValue.length - 1);
      }
      // 密码框置空
      function resetInput() {
        activeIndex = 0;
        resultValue = "";
        mui(".input-item").each(function(index, element) {
          (<HTMLElement>element).innerText = "";
        });
      }
      // 密码错误
      //function wrongPassword() {
      //  console.log("密码错误")
      //  //mui.confirm("密码错误", "验证结果", ["再来一次", "密码忘了"], function(event) {
      //  //  var index = event.index;
      //  //  if(index == 0) {
      //  //    //mui.toast("请再次输入");
      //  //  } else {
      //  //    //mui.toast("下一步跳转到忘记密码的页面");
      //  //  }
      //  //  resetInput();
      //  //});
      //}

    }.bind(this));

  }

   showKeyboard(){
        $('.box').css('display','block');
    }
  //发布货源
  public publishOrderInfo(OrderNo:string,password:string):Promise<any>{

    let ownerPublishPayDTO={
        "insurance": 1,
        "orderNo": OrderNo,
        "password":md5(password),
        "userCode": localStorage['walletCode']
    };
    console.log(password);
    //let params = Object.keys(ownerPublishPayDTO).map(key=>key+'='+ownerPublishPayDTO[key]).join('&');
    return this.ajax.myPost(Api.publishOrderInfo,ownerPublishPayDTO).toPromise();//.then(data=>console.log(data))

  }
//忘记密码
  pw(){
    this.router.navigateByUrl("personalCenter/Mondify");
  }
}
